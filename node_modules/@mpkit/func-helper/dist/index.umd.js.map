{"version":3,"file":"index.umd.js","sources":["../replace.ts","../hook.ts"],"sourcesContent":["import { MkReplaceFuncCallback } from \"@mpkit/types\";\n\nexport function replaceFunc<T extends Function = Function>(\n    original: T,\n    replacer: T,\n    callback?: MkReplaceFuncCallback,\n    data?: any\n): T {\n    let isReplace = true;\n    callback &&\n        callback({\n            data,\n            original,\n            replace() {\n                isReplace = true;\n            },\n            restore() {\n                isReplace = false;\n            },\n        });\n    return (function (...args) {\n        if (isReplace) {\n            return replacer.apply(this, args);\n        } else {\n            return original.apply(this, args);\n        }\n    } as unknown) as T;\n}\n","import {\n    MkFuncHook,\n    MkFuncHookErrorType,\n    MkFuncHookHandler,\n    MkFuncHookName,\n    MkFuncHookResult,\n    MkFuncHookState,\n} from \"@mpkit/types\";\n\n/**使用多种钩子钩住函数，并返回处理后的函数 */\nexport const hookFunc = (() => {\n    const isFunc = (item: any) =>\n        typeof item === \"function\" ||\n        (Array.isArray(item) &&\n            (item as any[]).some((it) => typeof it === \"function\"));\n    const hookNames = [\"before\", \"after\", \"catch\", \"complete\", \"done\"];\n    return <T extends Function = Function, S = any>(\n        func: T,\n        hooksInvariant: boolean,\n        hooks: MkFuncHook<S>[],\n        otherState?: any\n    ): MkFuncHookResult => {\n        let enabled: any = {\n            before: 1,\n            after: 1,\n            catch: 1,\n            complete: 1,\n            done: 1,\n        };\n        const has: any = {};\n\n        const hasHook = (name: MkFuncHookName): boolean => {\n            if (!hooksInvariant) {\n                // 如果hooks不是恒定的，则需要每次动态查询\n                return hooks.some((item) => item && isFunc(item[name]));\n            }\n            if (!(name in has)) {\n                hooks.forEach((item) => {\n                    if (!item) {\n                        return;\n                    }\n                    hookNames.forEach((n) => {\n                        if (isFunc(item[n])) {\n                            has[n] = 1;\n                        }\n                    });\n                });\n                hookNames.forEach((n) => {\n                    if (!(n in has)) {\n                        has[n] = 0;\n                    }\n                });\n            }\n            return has[name];\n        };\n        const targetFunc = (function MkFuncHelperOfHookTarget(...args) {\n            const ctx = this;\n            const state: MkFuncHookState<S> = {\n                ctx,\n                func,\n                args,\n                state: {} as S,\n                stepResultList: [],\n                doneCallback(err: Error, res?: any): any {\n                    if (state.done) {\n                        return;\n                    }\n                    if (err) {\n                        fireCatch(\"RejectReason\", err);\n                        state.fulfilled = false;\n                    } else {\n                        state.value = res;\n                        state.fulfilled = true;\n                    }\n                    fireHook(\"complete\");\n                    checkFireDone(\"callback\");\n                },\n            };\n            if (otherState) {\n                Object.assign(state.state, otherState);\n            }\n\n            const fireHook = (name: MkFuncHookName) => {\n                if (name !== \"done\" && name !== \"catch\" && state.stop) {\n                    return;\n                }\n                let needExec = !enabled[name]\n                    ? false\n                    : hooksInvariant\n                    ? hasHook(name)\n                    : true;\n                if (needExec) {\n                    try {\n                        for (let i = 0, len = hooks.length; i < len; i++) {\n                            const hook = hooks[i];\n                            if (hook && hook[name]) {\n                                if (Array.isArray(hook[name])) {\n                                    const list = hook[\n                                        name\n                                    ] as MkFuncHookHandler<S>[];\n                                    for (\n                                        let j = 0, lj = list.length;\n                                        j < lj;\n                                        j++\n                                    ) {\n                                        state.stepResultList.push({\n                                            step: name,\n                                            result: list[j]\n                                                ? list[j](state)\n                                                : undefined,\n                                        });\n                                        if (\n                                            name !== \"done\" &&\n                                            name !== \"catch\" &&\n                                            state.stop\n                                        ) {\n                                            break;\n                                        }\n                                    }\n                                } else {\n                                    state.stepResultList.push({\n                                        step: name,\n                                        result: (hook[\n                                            name\n                                        ] as MkFuncHookHandler<S>)(state),\n                                    });\n                                }\n                            }\n                            if (\n                                name !== \"done\" &&\n                                name !== \"catch\" &&\n                                state.stop\n                            ) {\n                                break;\n                            }\n                        }\n                    } catch (e) {\n                        const type = `${name[0].toUpperCase()}${name.substr(\n                            1\n                        )}Exception` as MkFuncHookErrorType;\n                        if (name !== \"catch\") {\n                            fireCatch(type, e);\n                        } else {\n                            state.errors.push({\n                                type,\n                                error: e,\n                            });\n                        }\n                    }\n                }\n            };\n            const fireCatch = (type: MkFuncHookErrorType, error) => {\n                if (!state.errors) {\n                    state.errors = [];\n                }\n                state.errors.push({\n                    type,\n                    error,\n                });\n                if (hasHook(\"catch\")) {\n                    try {\n                        fireHook(\"catch\");\n                    } catch (e) {\n                        state.errors.push({\n                            type: \"CatchException\",\n                            error: e,\n                        });\n                    }\n                }\n            };\n            const doneStep: any = {};\n            const checkFireDone = (step: string) => {\n                doneStep[step] = 1;\n                const isPromise =\n                    typeof state.result === \"object\" &&\n                    state.result &&\n                    (state.result.then || state.result.catch);\n                if (state.needDoneCallback && isPromise) {\n                    if (doneStep.promise && doneStep.callback) {\n                        state.done = true;\n                        fireHook(\"done\");\n                    }\n                } else {\n                    state.done = true;\n                    fireHook(\"done\");\n                }\n            };\n            fireHook(\"before\");\n            if (state.stop) {\n                fireHook(\"done\");\n                return state.result;\n            }\n            try {\n                const res = func.apply(ctx, args);\n                state.result = res;\n                fireHook(\"after\");\n                const isPromise =\n                    typeof state.result === \"object\" &&\n                    state.result &&\n                    (state.result.then || state.result.catch);\n                if (state.needDoneCallback || isPromise) {\n                    if (isPromise && state.result.then) {\n                        state.result.then((value) => {\n                            state.value = value;\n                            state.fulfilled = true;\n                            fireHook(\"complete\");\n                            checkFireDone(\"promise\");\n                        });\n                    }\n                    if (isPromise && state.result.catch) {\n                        state.result.catch((e) => {\n                            state.fulfilled = false;\n                            fireCatch(\"RejectReason\", e);\n                            fireHook(\"complete\");\n                            checkFireDone(\"promise\");\n                        });\n                    }\n                } else {\n                    fireHook(\"done\");\n                }\n                return state.result;\n            } catch (e) {\n                fireCatch(\"MethodException\", e);\n                fireHook(\"done\");\n                throw e;\n            }\n        } as unknown) as T;\n        return {\n            func: targetFunc,\n            disable(name?: MkFuncHookName) {\n                if (name) {\n                    enabled[name] = 0;\n                } else {\n                    hookNames.forEach((n) => {\n                        enabled[n] = 0;\n                    });\n                }\n            },\n            enable(name?: MkFuncHookName) {\n                if (name) {\n                    enabled[name] = 1;\n                } else {\n                    hookNames.forEach((n) => {\n                        enabled[n] = 1;\n                    });\n                }\n            },\n        };\n    };\n})();\n"],"names":["replaceFunc","original","replacer","callback","data","isReplace","replace","restore","_i","args","apply","hookFunc","isFunc","item","Array","isArray","some","it","hookNames","func","hooksInvariant","hooks","otherState","enabled","before","after","complete","done","has","hasHook","name","forEach","n","targetFunc","MkFuncHelperOfHookTarget","ctx","state","stepResultList","doneCallback","err","res","fireCatch","fulfilled","value","fireHook","checkFireDone","Object","assign","stop","needExec","i","len","length","hook","list","j","lj","push","step","result","undefined","e","type","toUpperCase","substr","errors","error","doneStep","isPromise","then","needDoneCallback","promise","disable","enable"],"mappings":"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"}